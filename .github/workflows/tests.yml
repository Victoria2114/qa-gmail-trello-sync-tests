name: CI - Automation tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:   # allows manual run from the Actions tab

jobs:
  tests:
    runs-on: ubuntu-latest

    env:
      # Trello credentials are passed from GitHub Secrets (not from code)
      TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
      TRELLO_API_TOKEN: ${{ secrets.TRELLO_API_TOKEN }}
      TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}

      # If you later move Gmail credentials to env vars, you can add them here too:
      # GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
      # GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
      # GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install browsers for Playwright (even if we only run API now)
          python -m playwright install --with-deps

      - name: Run API automation tests with pytest
        run: |
          pytest -m api --alluredir=allure-results -vv

      - name: Upload Allure results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results
